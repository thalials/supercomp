
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://insper.github.io/supercomp/aulas/14-intro-gpu/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.11">
    
    
      
        <title>17 - Introdução a GPU - SuperComputação - 2022/1</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50e68009.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#757575">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/printing.css">
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="grey" data-md-color-accent="red">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#17-introducao-a-gpu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SuperComputação - 2022/1" class="md-header__button md-logo" aria-label="SuperComputação - 2022/1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SuperComputação - 2022/1
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              17 - Introdução a GPU
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SuperComputação - 2022/1" class="md-nav__button md-logo" aria-label="SuperComputação - 2022/1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    SuperComputação - 2022/1
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../sobre/" class="md-nav__link">
        Burocracias
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Aulas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Aulas" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Aulas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01-introducao/" class="md-nav__link">
        01 - Introdução
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../02-03-implementacao-c%2B%2B/" class="md-nav__link">
        02 e 03 - C++
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../04-profiling/" class="md-nav__link">
        04 - Profiling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../05-heuristicas/" class="md-nav__link">
        05 - Heurísticas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../06-aleatorizacao/" class="md-nav__link">
        06 - Aleatorização
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../07-busca-local/" class="md-nav__link">
        07 - Busca Local
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../08-busca-global/" class="md-nav__link">
        08 - Busca Exaustiva
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../09-busca-global-II/" class="md-nav__link">
        09 - Comparação de desempenho
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../10-branch-and-bound/" class="md-nav__link">
        10 - Branch and Bound
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Projeto
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Projeto" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Projeto
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../projetos/" class="md-nav__link">
        Alinhamento de Sequencias de DNA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../projetos/heuristico/" class="md-nav__link">
        Heurística de Alinhamento Local de Smith-Waterman
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../projetos/local/" class="md-nav__link">
        Um algoritmo Local para Alinhamento
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#compilacao-para-gpu" class="md-nav__link">
    Compilação para GPU
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilacao-para-cpu" class="md-nav__link">
    Compilação para CPU
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transferencia-de-dados" class="md-nav__link">
    Transferência de dados
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operacoes-de-reducao" class="md-nav__link">
    Operações de redução
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transformacoes-ponto-a-ponto" class="md-nav__link">
    Transformações ponto a ponto
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/insper/supercomp/edit/master/docs/aulas/14-intro-gpu/index.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="17-introducao-a-gpu">17 - Introdução a GPU<a class="headerlink" href="#17-introducao-a-gpu" title="Permanent link">&para;</a></h1>
<p>Como visto em aula, programação para GPU requer ferramentas especializadas capazes de gerar código que rode parte na CPU (chamada de <em>host</em>) e parte na GPU (chamada de <em>target</em>). Nesta parte introdutória usaremos a biblioteca <code>cuda::thrust</code>. Ela possui um pequeno conjunto de operações otimizadas para GPU e que podem ser customizadas para diversos propósitos.</p>
<div class="admonition note">
<p class="admonition-title">Documentação oficial</p>
<p>A documentação oficial da Thrust está disponível no endereço <a href="https://thrust.github.io/doc/modules.html">https://thrust.github.io/doc/modules.html</a>.</p>
</div>
<p>Também vamos focar em usar máquinas pré-configuradas.</p>
<h2 id="compilacao-para-gpu">Compilação para GPU<a class="headerlink" href="#compilacao-para-gpu" title="Permanent link">&para;</a></h2>
<p>Para compilar programas para rodar na GPU devemos usar o compilador <code>nvcc</code>. Ele identifica quais porções do código deverão ser compiladas para a GPU. O restante do código, que roda exclusivamente na CPU, é passado diretamente para um compilador <em>C++</em> regular e um único executável é gerado contendo o código para CPU e chamadas inseridas pelo <code>nvcc</code> para invocar as funções que rodam na GPU.</p>
<p>O <code>nvcc</code> e todas as bibliotecas que precisamos estão disponíveis no pacote <code>nvidia-cuda-toolkit</code> pronto para instalação via <em>apt</em>. A versão disponibilizada não é a mais atual, mas tudo funciona de maneira integrada e não é necessário instalar nada manualmente.</p>
<div class="admonition warning">
<p class="admonition-title">Se você usar as VMs do Insper então não precisa fazer nada. Todas as ferramentas já estão instaladas lá e a VM já vem pronta para uso.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Verifique que sua instalação funciona compilando o arquivo abaixo.</p>
<blockquote>
<p>$ nvcc -arch=sm_70 -std=c++14 exemplo1-criacao-iteracao.cu -o exemplo1</p>
</blockquote>
</div>
<p>Se der tudo certo a execução do programa acima deverá gerar um executável <code>exemplo1</code> que roda e produz o seguinte resultado.</p>
<div class="highlight"><pre><span></span><code>Host vector: 0 0 12 0 35
Device vector 0 0 0 0 35
</code></pre></div>
<h2 id="compilacao-para-cpu">Compilação para CPU<a class="headerlink" href="#compilacao-para-cpu" title="Permanent link">&para;</a></h2>
<p>Se você ainda não tem uma GPU pode usar o suporte da <code>thrust</code> para OpenMP nas nossas primeiras aulas.</p>
<div class="admonition danger">
<p class="admonition-title">Todos os trabalhos serão corrigidos usando GPU usando <code>nvcc</code>. Esta alternativa é importante somente para as primeiras aulas, em que nem todos terão acesso ainda a uma GPU. Usaremos isso somente para facilitar o primeiro contato, mas essa opção não é válida para avaliações.</p>
</div>
<ol>
<li>baixar o código fonte da <code>thrust</code> <a href="https://github.com/NVIDIA/thrust">no github</a>.</li>
<li>adicionar as seguintes flags no g++<ul>
<li><code>-DTHRUST_DEVICE_SYSTEM=THRUST_DEVICE_SYSTEM_OMP</code>: diz que a paralelização de <code>device_vetor</code> será usando OpenMP</li>
<li><code>-I/home/....</code>: o caminho passado será usado na busca por <code>include</code>s. Coloque o caminho do repositório da <code>thrust</code></li>
<li><code>-fopenmp</code>: já conhecemos este ;)</li>
<li><code>-x c++</code>: força a compilação de arquivos <code>.cu</code> como código fonte C++</li>
</ul>
</li>
</ol>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Verifique que sua instalação funciona compilando o arquivo abaixo.</p>
<blockquote>
<p>$ g++ -DTHRUST_DEVICE_SYSTEM=THRUST_DEVICE_SYSTEM_OMP -I/caminho/para/thrust/  -fopenmp -x c++ exemplo1-criacao-iteracao.cu -o exemplo1-cpu</p>
</blockquote>
</div>
<p>Se der tudo certo a execução do programa acima deverá gerar um executável <code>exemplo1-cpu</code> que roda e produz o seguinte resultado.</p>
<div class="highlight"><pre><span></span><code>Host vector: 0 0 12 0 35
Device vector 0 0 0 0 35
</code></pre></div>
<div class="admonition danger">
<p class="admonition-title">Nem tudo o que roda usando thrust/OpenMP roda em GPU. Por essa razão, esse recurso será usado somente para testes e nunca para avaliação.</p>
</div>
<h2 id="transferencia-de-dados">Transferência de dados<a class="headerlink" href="#transferencia-de-dados" title="Permanent link">&para;</a></h2>
<p>Como visto na expositiva, a CPU e a GPU possuem espaços de endereçamento completamente distintos. Ou seja, a CPU não consegue acessar os dados na memória da GPU e vice-versa. A <code>thrust</code> disponibiliza somente um tipo de container (<code>vector</code>) e facilita este gerenciamento deixando explícito se ele está alocado na CPU (<code>host</code>) ou na GPU (<code>device</code>).  A cópia CPU<span class="arithmatex"><span class="MathJax_Preview">\leftrightarrow</span><script type="math/tex">\leftrightarrow</script></span> GPU é feita implicitamente quando criamos um <code>device_vector</code> ou quando usamos a operação de atribuição entre <code>host_vector</code> e <code>device_vector</code>. Veja o exemplo abaixo:</p>
<div class="highlight"><pre><span></span><code><span class="n">thrust</span><span class="o">::</span><span class="n">host_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vec_cpu</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="c1">// alocado na CPU</span>

<span class="n">vec1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"></span>
<span class="n">vec2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w"></span>

<span class="c1">// aloca vetor na GPU e transfere dados CPU-&gt;GPU</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vec_gpu</span><span class="w"> </span><span class="p">(</span><span class="n">vec_cpu</span><span class="p">);</span><span class="w"></span>

<span class="c1">//processa vec_gpu</span>

<span class="n">vec_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_gpu</span><span class="p">;</span><span class="w"> </span><span class="c1">// copia dados GPU -&gt; CPU</span>
</code></pre></div>
<p>A <code>thrust</code> usa iteradores em todas as suas funções. Pense em um iterador como um ponteiro para os elementos do array. Porém, um iterador é mais esperto: ele guarda também o tipo do vetor original e suporta operações <code>++</code> e <code>*</code> para qualquer tipo de dado iterado de maneira transparente.</p>
<p>Vetores <code>thrust</code> aceitam os métodos <code>v.begin()</code> para retornar um iterador para o começo do vetor e <code>v.end()</code> para um iterador para o fim (depois do último elemento). Podemos também somar um valor <code>n</code> a um iterador. Isto é equivalente a fazer <code>n</code> vezes a operação <code>++</code>.  Veja abaixo um exemplo de uso das funções <code>fill</code> e <code>sequence</code> para preencher valores em um vetor de maneira eficiente.</p>
<div class="highlight"><pre><span></span><code><span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// vetor de 5 ints zerado</span>
<span class="c1">// v = {0, 0, 0, 0, 0}</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">sequence</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"> </span><span class="c1">// preenche com 0, 1, 2, ....</span>
<span class="c1">// v = {0, 1, 2, 3, 4}</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">);</span><span class="w"> </span><span class="c1">// dois primeiros elementos = 13</span>
<span class="c1">// v = {13, 13, 2, 3, 4}</span>
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Consulte o arquivo <em>exemplo1-criacao-iteracao.cu</em> para um exemplo completo de alocação e transferência de dados e do uso de iteradores.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>O fluxo de trabalho "normal" de aplicações usando GPU é receber os dados em um vetor na CPU e copiá-los para a GPU para fazer processamentos. Crie um programa que lê uma sequência de <code>double</code>s da entrada padrão em um <code>thrust::host_vector</code> e os copia para um <code>thrust::device_vector</code>. Teste seu programa com o arquivo <em>stocks-google.txt</em>, que contém o preço das ações do Google nos últimos 10 anos.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>A criação de um <code>device_vector</code> é demorada. Meça o tempo que a operação de alocação e cópia demora e imprima na saída de erros. (Use <code>std::chrono</code>).</p>
</div>
<h2 id="operacoes-de-reducao">Operações de redução<a class="headerlink" href="#operacoes-de-reducao" title="Permanent link">&para;</a></h2>
<p>Uma operação genérica de <em>redução</em> transforma um vetor em um único valor. Exemplos clássicos de operações de redução incluem <em>soma</em>, <em>média</em> e <em>mínimo/máximo</em> de um vetor.</p>
<p>A <code>thrust</code> disponibiliza este tipo de operação otimizada em <em>GPU</em> usando a função <code>thrust::reduce</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thrust</span><span class="o">::</span><span class="n">reduce</span><span class="p">(</span><span class="n">iter_comeco</span><span class="p">,</span><span class="w"> </span><span class="n">iter_fim</span><span class="p">,</span><span class="w"> </span><span class="n">inicial</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="c1">// iter_comeco: iterador para o começo dos dados</span>
<span class="c1">// iter_fim: iterador para o fim dos dados</span>
<span class="c1">// inicial: valor inicial</span>
<span class="c1">// op: operação a ser feita.</span>
</code></pre></div>
<p>Um exemplo de uso de redução para computar o máximo pode ser visto <a href="http://thrust.github.io/doc/group__reductions_ga5e9cef4919927834bec50fc4829f6e6b.html#ga5e9cef4919927834bec50fc4829f6e6b">aqui</a>. A lista completa de funções que podem ser usadas no lugar de <code>op</code> pode ser vista <a href="http://thrust.github.io/doc/group__predefined__function__objects.html">neste link</a>.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Continuando o exercício anterior, calcule as seguintes medidas. Não se esqueça de passar o <code>device_vector</code> para a sua função <code>reduce</code></p>
<ol>
<li>O preço médio das ações nos últimos 10 anos.</li>
<li>O preço médio das ações no último ano (365 dias atrás).</li>
<li>O maior e o menor preço da sequência inteira e do último ano.</li>
</ol>
</div>
<p>Você pode consultar todos os tipos de reduções disponíveis no <a href="https://thrust.github.io/doc/group__reductions.html">site da thrust</a>.</p>
<h2 id="transformacoes-ponto-a-ponto">Transformações ponto a ponto<a class="headerlink" href="#transformacoes-ponto-a-ponto" title="Permanent link">&para;</a></h2>
<p>Além de operações de redução também podemos fazer operações ponto a ponto em somente um vetor (como negar todas as componentes ou calcular os quadrados) quanto entre dois vetores (como somar dois vetores componente por componente ou comparar cada elemento com seu correspondente em outro vetor). A <code>thrust</code> dá o nome de <code>transformation</code> para este tipo de operação.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// para operações entre dois vetores iter1 e iter2. resultado armazenado em out</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">iter1_comeco</span><span class="p">,</span><span class="w"> </span><span class="n">iter1_fim</span><span class="p">,</span><span class="w"> </span><span class="n">iter2_comeco</span><span class="p">,</span><span class="w"> </span><span class="n">out_comeco</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="c1">// iter1_comeco: iterador para o começo de iter1</span>
<span class="c1">// iter1_fim: iterador para o fim de iter1</span>
<span class="c1">// iter2_comeco: iterador para o começo de iter2</span>
<span class="c1">// out_comeco: iterador para o começo de out</span>
<span class="c1">// op: operação a ser realizada.</span>
</code></pre></div>
<p>Um exemplo concreto pode ser visto abaixo. O código completo está em <code>exemplo2-transform.cu</code></p>
<div class="highlight"><pre><span></span><code><span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">V1</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">V2</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">V3</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">V4</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="c1">// inicializa V1 e V2 aqui</span>

<span class="c1">//soma V1 e V2</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">V1</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">V1</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">V2</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">V3</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">thrust</span><span class="o">::</span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>

<span class="c1">// multiplica V1 por 0.5</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">V1</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">V1</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"></span>
<span class="w">                  </span><span class="n">thrust</span><span class="o">::</span><span class="n">constant_iterator</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span><span class="w"></span>
<span class="w">                  </span><span class="n">V4</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">thrust</span><span class="o">::</span><span class="n">multiplies</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
</code></pre></div>
<p>As operações que foram usadas no <code>reduce</code> também podem ser usadas em um <code>transform</code>. Não se esqueça de consultar <a href="http://thrust.github.io/doc/group__predefined__function__objects.html">a lista de operações</a> para fazer este exercício.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Vamos agora trabalhar com o arquivo <code>stocks2.csv</code>. Ele contém a série histórica de ações da Apple e da Microsoft. Seu objetivo é calcular a diferença média entre os preços das ações AAPL e MSFT.</p>
<p><strong>Dica</strong>: quebre o problema em duas partes. Primeiro calcule a diferença entre os preços e guarde isto em um vetor. Depois compute a média deste vetor.</p>
</div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.092fa1f6.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a9542cf.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.0.0/js-yaml.min.js"></script>
      
        <script src="../../js/markdown-enhancer.js"></script>
      
        <script src="../../js/slides.js"></script>
      
    
  </body>
</html>